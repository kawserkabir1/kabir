const chatLog=document.getElementById("chatLog"),messageInput=document.getElementById("messageInput"),sendButton=document.getElementById("sendButton"),stopButton=document.getElementById("stopButton"),typingIndicator=document.getElementById("typingIndicator"),errorMessageDiv=document.getElementById("errorMessage"),modelDisplay=document.getElementById("modelDisplay"),initialGreeting=document.getElementById("initialGreeting"),API_BASE_URL="https://api.novita.ai/v3/openai",CHAT_COMPLETIONS_URL=`${API_BASE_URL}/chat/completions`,MODEL_NAME="deepseek/deepseek-v3-turbo",NOVITA_API_KEY="sk_swn2nTq1BArWbdv2gdGluR1_759HNE6yCi36k_Cdxh0";let chatHistory=[],currentAbortController=null;const markdownConverter=new showdown.Converter({ghCompatibleHeaderId:!0,simpleLineBreaks:!0,simplifiedAutoLink:!0,strikethrough:!0,tables:!0,tasklists:!0,literalMidWordUnderscores:!0,parseImgDimensions:!0,ghCodeBlocks:!0});markdownConverter.setFlavor("github");const assistantAvatarHtml='<div class="assistant-avatar"><img src="./main.png" alt="LazyFox Avatar"></div>',editIconSvg='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg>';function addMessageToLog(e,t,n=null){const o=document.createElement("div");o.classList.add("message-container","user"===e?"user-message-container":"assistant-message-container"),o.dataset.role=e;const s=document.createElement("div");if(s.classList.add("message-bubble"),"assistant"===e)o.innerHTML+=assistantAvatarHtml,s.innerHTML=markdownConverter.makeHtml(t||"");else{const e=document.createElement("button");e.className="edit-button",e.title="Edit this message",e.innerHTML=editIconSvg,o.appendChild(e),s.textContent=t,s.dataset.rawText=t}return o.appendChild(s),n?(n.appendChild(o),s):(chatLog.appendChild(o),"assistant"===e&&finalizeAssistantMessage(s),chatLog.scrollTop=chatLog.scrollHeight,null)}function updateStreamingMessage(e,t){let n=e.dataset.rawContent||"";n+=t,e.dataset.rawContent=n,e.innerHTML=markdownConverter.makeHtml(n),chatLog.scrollTop=chatLog.scrollHeight}function finalizeAssistantMessage(e){if(!e)return;e.querySelectorAll("pre code").forEach((e=>{try{hljs.highlightElement(e)}catch(e){console.error("Highlight.js error:",e)}const t=e.parentElement;if(t&&"PRE"===t.tagName&&!t.querySelector(".copy-code-button")){const n=document.createElement("button");n.textContent="Copy",n.className="copy-code-button",n.addEventListener("click",(()=>{navigator.clipboard.writeText(e.textContent).then((()=>{n.textContent="Copied!",setTimeout((()=>{n.textContent="Copy"}),2e3)})).catch((e=>{console.error("Failed to copy:",e),n.textContent="Error",setTimeout((()=>{n.textContent="Copy"}),2e3)}))})),t.appendChild(n)}})),setTimeout((()=>{chatLog&&(chatLog.scrollTop=chatLog.scrollHeight)}),50)}async function sendMessage(){const e=messageInput.value.trim(),t=NOVITA_API_KEY;if(!e||sendButton.disabled)return;currentAbortController=new AbortController,addMessageToLog("user",e),chatHistory.push({role:"user",content:e}),messageInput.value="",setLoadingState(!0),hideError();const n=addMessageToLog("assistant","",document.createElement("div"));if(!n||!n.parentElement)return console.error("Failed to create assistant message bubble."),void setLoadingState(!1);chatLog.appendChild(n.parentElement),n.dataset.rawContent="";let o="";try{const e=await fetch(CHAT_COMPLETIONS_URL,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json",Accept:"text/event-stream"},body:JSON.stringify({model:MODEL_NAME,messages:chatHistory,stream:!0}),signal:currentAbortController.signal});if(!e.ok){let t;try{t=await e.json()}catch(e){}console.error("API Error:",t);let n="";if(n="string"==typeof t?.detail?t.detail:Array.isArray(t?.detail)?t.detail.map((e=>`${e.loc?.join(".")+": "??""}${e.msg}`)).join("; "):t?.message?t.message:`HTTP Error: ${e.status}`,404===e.status||n.toLowerCase().includes("model_not_found")||n.toLowerCase().includes("not found"))throw new Error(`Model "${MODEL_NAME}" not found or unavailable. Check Novita.ai docs.`);throw new Error(`API request failed: ${n}`)}if(!e.body)throw new Error("Response body missing.");const s=e.body.getReader(),a=new TextDecoder;let r="";for(;!currentAbortController.signal.aborted;){const{value:e,done:t}=await s.read();if(t)break;r+=a.decode(e,{stream:!0});let i=r.split("\n");r=i.pop();for(const e of i)if(e.startsWith("data: ")){const t=e.substring(5).trim();if("[DONE]"!==t)try{const e=JSON.parse(t),s=e.choices?.[0]?.delta?.content;s&&(o+=s,updateStreamingMessage(n,s))}catch(e){console.warn("Failed to parse JSON:",t,e)}}}chatHistory.push({role:"assistant",content:o}),finalizeAssistantMessage(n)}catch(e){"AbortError"===e.name?(console.log("Fetch aborted."),showError("Generation stopped."),o&&chatHistory.push({role:"assistant",content:o+" [Stopped]"}),finalizeAssistantMessage(n)):(console.error("Chat failed:",e),showError(`Error: ${e.message}`),n&&!n.dataset.rawContent?n.closest(".message-container")?.remove():n&&finalizeAssistantMessage(n))}finally{currentAbortController=null,setLoadingState(!1)}}function setLoadingState(e){messageInput.disabled=e,sendButton.classList.toggle("hidden",e),stopButton.classList.toggle("hidden",!e),typingIndicator.classList.toggle("hidden",!e),e||messageInput.focus()}function showError(e){errorMessageDiv.textContent=e,errorMessageDiv.classList.remove("hidden")}function hideError(){errorMessageDiv.classList.add("hidden"),errorMessageDiv.textContent=""}sendButton.addEventListener("click",sendMessage),messageInput.addEventListener("keydown",(e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),sendMessage())})),stopButton.addEventListener("click",(()=>{currentAbortController&&(currentAbortController.abort(),console.log("Stop generation requested."))})),chatLog.addEventListener("click",(e=>{const t=e.target.closest(".edit-button");if(t){const e=t.closest(".message-container"),n=e?.querySelector(".message-bubble");if(n){const e=n.dataset.rawText;void 0!==e?(messageInput.value=e,messageInput.focus(),console.log("Copied message to input.")):console.warn("Could not find original text for editing.")}}})),document.addEventListener("DOMContentLoaded",(()=>{try{if(document.getElementById("currentYear").textContent=(new Date).getFullYear(),modelDisplay&&(modelDisplay.textContent=MODEL_NAME),initialGreeting){MODEL_NAME.split("/").pop();initialGreeting.textContent="Hello! I'm LazyFox, using the ChatGPT 3 model. How can I help?"}0,messageInput.focus()}catch(e){console.error("Error during initial setup:",e),document.body.insertAdjacentHTML("afterbegin",'<div style="background:red; color:white; padding:1rem; text-align:center; font-family:sans-serif;">Site Initialization Error. Check console.</div>')}}));