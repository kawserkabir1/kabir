tailwind.config={theme:{extend:{colors:{primary:"#8b5cf6",secondary:"#ec4899"},animation:{"gradient-x":"gradient-x 10s ease infinite"},keyframes:{"gradient-x":{"0%, 100%":{backgroundSize:"200% 200%",backgroundPosition:"left center"},"50%":{backgroundSize:"200% 200%",backgroundPosition:"right center"}}}}}};const chatLog=document.getElementById("chatLog"),messageInput=document.getElementById("messageInput"),sendButton=document.getElementById("sendButton"),stopButton=document.getElementById("stopButton"),fileInput=document.getElementById("fileInput"),typingIndicator=document.getElementById("typingIndicator"),errorMessageDiv=document.getElementById("errorMessage"),API_BASE_URL="https://api.novita.ai/v3/openai",CHAT_COMPLETIONS_URL=`${API_BASE_URL}/chat/completions`,MODEL_NAME="deepseek/deepseek-r1-turbo",NOVITA_API_KEY="sk_swn2nTq1BArWbdv2gdGluR1_759HNE6yCi36k_Cdxh0";let chatHistory=[],currentAbortController=null;const markdownConverter=new showdown.Converter({ghCompatibleHeaderId:!0,simpleLineBreaks:!0,simplifiedAutoLink:!0,strikethrough:!0,tables:!0,tasklists:!0,literalMidWordUnderscores:!0,parseImgDimensions:!0,ghCodeBlocks:!0});markdownConverter.setFlavor("github");const assistantAvatarHtml='<div class="assistant-avatar"><img src="./main.png" alt="LazyFox Avatar"></div>';function addMessageToLog(e,t,n=null){const o=document.createElement("div");o.classList.add("message-container","user"===e?"user-message-container":"assistant-message-container");const s=document.createElement("div");return s.classList.add("message-bubble"),"assistant"===e?(o.innerHTML+=assistantAvatarHtml,s.innerHTML=markdownConverter.makeHtml(t||"")):s.textContent=t,o.appendChild(s),n?(n.appendChild(o),s):(chatLog.appendChild(o),finalizeAssistantMessage(s),chatLog.scrollTop=chatLog.scrollHeight,null)}function updateStreamingMessage(e,t){let n=e.dataset.rawContent||"";n+=t,e.dataset.rawContent=n,e.innerHTML=markdownConverter.makeHtml(n),chatLog.scrollTop=chatLog.scrollHeight}function finalizeAssistantMessage(e){if(!e)return;e.querySelectorAll("pre code").forEach((e=>{try{hljs.highlightElement(e)}catch(e){console.error("Highlight.js error:",e)}const t=e.parentElement;if(t&&"PRE"===t.tagName&&!t.querySelector(".copy-code-button")){const n=document.createElement("button");n.textContent="Copy",n.className="copy-code-button",n.addEventListener("click",(()=>{navigator.clipboard.writeText(e.textContent).then((()=>{n.textContent="Copied!",setTimeout((()=>{n.textContent="Copy"}),2e3)})).catch((e=>{console.error("Failed to copy:",e),n.textContent="Error",setTimeout((()=>{n.textContent="Copy"}),2e3)}))})),t.appendChild(n)}})),setTimeout((()=>{chatLog&&(chatLog.scrollTop=chatLog.scrollHeight)}),50)}async function sendMessage(){const e=messageInput.value.trim(),t=NOVITA_API_KEY;if(!e||sendButton.disabled)return;currentAbortController=new AbortController,addMessageToLog("user",e),chatHistory.push({role:"user",content:e}),messageInput.value="",setLoadingState(!0),hideError();const n=document.createElement("div"),o=addMessageToLog("assistant","",n);chatLog.appendChild(n.firstChild),o.dataset.rawContent="";let s="";try{const e=await fetch(CHAT_COMPLETIONS_URL,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json",Accept:"text/event-stream"},body:JSON.stringify({model:MODEL_NAME,messages:chatHistory,stream:!0}),signal:currentAbortController.signal});if(!e.ok){let t;try{t=await e.json()}catch(e){}console.error("API Error:",t);let n="";throw n="string"==typeof t?.detail?t.detail:Array.isArray(t?.detail)?t.detail.map((e=>`${e.loc?.join(".")+": "??""}${e.msg}`)).join("; "):t?.message?t.message:`HTTP Error: ${e.status}`,new Error(`API request failed: ${n}`)}if(!e.body)throw new Error("Response body missing.");const n=e.body.getReader(),r=new TextDecoder;let a="";for(;!currentAbortController.signal.aborted;){const{value:e,done:t}=await n.read();if(t)break;a+=r.decode(e,{stream:!0});let i=a.split("\n");a=i.pop();for(const e of i)if(e.startsWith("data: ")){const t=e.substring(5).trim();if("[DONE]"!==t)try{const e=JSON.parse(t),n=e.choices?.[0]?.delta?.content;n&&(s+=n,updateStreamingMessage(o,n))}catch(e){console.warn("Failed to parse JSON:",t,e)}}}chatHistory.push({role:"assistant",content:s}),finalizeAssistantMessage(o)}catch(e){"AbortError"===e.name?(console.log("Fetch aborted by user."),showError("Generation stopped."),chatHistory.push({role:"assistant",content:s+" [Stopped]"}),finalizeAssistantMessage(o)):(console.error("Chat failed:",e),showError(`Error: ${e.message}`),o&&!o.dataset.rawContent?o.closest(".message-container")?.remove():o&&finalizeAssistantMessage(o))}finally{currentAbortController=null,setLoadingState(!1)}}function setLoadingState(e){messageInput.disabled=e,sendButton.classList.toggle("hidden",e),stopButton.classList.toggle("hidden",!e),uploadButton.disabled=e,typingIndicator.classList.toggle("hidden",!e),e||messageInput.focus()}function showError(e){errorMessageDiv.textContent=e,errorMessageDiv.classList.remove("hidden")}function hideError(){errorMessageDiv.classList.add("hidden"),errorMessageDiv.textContent=""}sendButton.addEventListener("click",sendMessage),messageInput.addEventListener("keydown",(e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),sendMessage())})),stopButton.addEventListener("click",(()=>{currentAbortController&&(currentAbortController.abort(),console.log("Stop generation requested by user."))})),document.getElementById("currentYear").textContent=(new Date).getFullYear();